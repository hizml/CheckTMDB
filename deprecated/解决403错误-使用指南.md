# 解决 403 错误 - 完整使用指南

## 问题现状

两个主要脚本都遇到了反爬虫限制：

1. **check_tmdb_github.py** 
   - 错误: `获取CSRF Token失败，HTTP状态码: 403`
   - 原因: dnschecker.org 网站加强了反爬虫措施

2. **check_tmdb_github_dnschecked.py**
   - 错误: `程序出错：未获取任何domain及对应IP`
   - 原因: dnschecked.com API 可能失效或限流

## 最佳解决方案

### 方案一：使用 check_tmdb_simple.py（强烈推荐）

**优势：**
- ✅ 不依赖任何第三方 API
- ✅ 直接使用系统 DNS 解析，最稳定
- ✅ 无需担心 API 失效或反爬虫
- ✅ 代码简单，易于维护
- ✅ 只依赖 Python 标准库（socket）

**使用方法：**

```bash
# 直接运行
python3 check_tmdb_simple.py
```

**工作原理：**
1. 使用 `socket.getaddrinfo()` 进行系统 DNS 查询
2. 获取每个域名的 IPv4 和 IPv6 地址
3. 如果有多个 IP，通过 TCP 连接测试延迟
4. 选择延迟最低的 IP
5. 更新 hosts 文件

**限制：**
- 只能获取你当前 DNS 服务器返回的 IP
- 无法指定特定国家/地区的 DNS 服务器（如日本、韩国）
- 但对于大多数使用场景已经足够

### 方案二：修复后的 check_tmdb_github.py

我已经修复了请求头格式错误的问题。

**修改内容：**
- 修复了 headers 字典格式错误（原来 'referer' 和 'User-Agent' 写在一起）
- 增加了完整的浏览器请求头
- 添加了 `X-Requested-With`, `Sec-Fetch-*` 等现代浏览器特征

**使用方法：**

```bash
python3 check_tmdb_github.py
```

**注意：**
虽然已修复代码错误，但如果 dnschecker.org 加强了反爬虫（如需要 cookies、验证码、JavaScript 挑战等），可能仍然会失败。

### 方案三：使用 check_tmdb_fixed.py（综合方案）

这个脚本结合了多种方法：

```bash
python3 check_tmdb_fixed.py
```

包含三层备用机制：
1. 尝试 dnschecked.com API
2. 失败则使用系统 DNS
3. 再失败则使用 Cloudflare DoH

## 推荐流程

```bash
# 第一步：尝试最简单稳定的方案
python3 check_tmdb_simple.py

# 如果需要特定地区的 IP，尝试修复后的脚本
python3 check_tmdb_github.py

# 如果都失败，尝试综合方案
python3 check_tmdb_fixed.py
```

## 各方案对比

| 方案 | 稳定性 | IP质量 | 依赖 | 推荐度 |
|------|--------|--------|------|--------|
| check_tmdb_simple.py | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | 无 | ⭐⭐⭐⭐⭐ |
| check_tmdb_fixed.py | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | requests | ⭐⭐⭐⭐ |
| check_tmdb_github.py | ⭐⭐ | ⭐⭐⭐⭐⭐ | requests, retry | ⭐⭐ |
| check_tmdb_github_dnschecked.py | ⭐ | ⭐⭐⭐⭐ | requests, retry | ⭐ |

## 为什么会出现 403 错误？

dnschecker.org 检测到了自动化请求的特征：

1. **请求头不完整**: 缺少现代浏览器的特征头
2. **请求频率过高**: 短时间内大量请求
3. **缺少 Cookies**: 正常浏览器会携带 session cookies
4. **TLS 指纹**: Python requests 的 TLS 握手与浏览器不同
5. **JavaScript 验证**: 网站可能增加了 JS 挑战

## 已修复的问题

### check_tmdb_github.py 

**原代码（第 148 行）：**
```python
headers = {
    'referer': 'https://dnschecker.org/country/{country_code}/','User-Agent': 'Mozilla/...'
}
```

问题：`'referer'` 和 `'User-Agent'` 写在一起，导致只有一个键。

**修复后：**
```python
headers = {
    'Accept': 'application/json, text/javascript, */*; q=0.01',
    'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
    'Accept-Encoding': 'gzip, deflate, br',
    'Referer': f'https://dnschecker.org/country/{country_code}/',
    'User-Agent': 'Mozilla/5.0 ...',
    'X-Requested-With': 'XMLHttpRequest',
    'Sec-Ch-Ua': '"Microsoft Edge";v="131"...',
    'Sec-Ch-Ua-Mobile': '?0',
    'Sec-Ch-Ua-Platform': '"Windows"',
    'Sec-Fetch-Dest': 'empty',
    'Sec-Fetch-Mode': 'cors',
    'Sec-Fetch-Site': 'same-origin'
}
```

## 更新 GitHub Actions

建议修改 `.github/workflows/main.yml` 使用稳定方案：

```yaml
- name: Run Python script
  run: |
    # 优先使用简单稳定的方案
    sudo python check_tmdb_simple.py || \
    # 备用方案
    sudo python check_tmdb_fixed.py || \
    # 最后尝试原方案
    sudo python check_tmdb_github.py || \
    echo "All methods failed"
```

## 长期建议

1. **定期更新 User-Agent**: 使用最新的浏览器版本号
2. **添加延迟**: 在请求之间增加随机延迟
3. **使用代理**: 如果 IP 被封，考虑使用代理池
4. **监控 API 变化**: 定期检查第三方 API 是否有更新
5. **优先使用本地方法**: 减少对外部服务的依赖

## 故障排除

### 如果 check_tmdb_simple.py 也失败

```bash
# 测试系统 DNS 是否正常
python3 -c "import socket; print(socket.getaddrinfo('tmdb.org', None))"

# 检查网络连接
ping tmdb.org

# 尝试更换 DNS 服务器
# macOS: 系统偏好设置 > 网络 > 高级 > DNS
# 添加: 8.8.8.8 (Google) 或 1.1.1.1 (Cloudflare)
```

### 如果需要特定地区 IP

考虑使用 DOH (DNS-over-HTTPS) 指定地区：

```python
# 使用 Cloudflare 的日本节点
import requests

response = requests.get(
    'https://cloudflare-dns.com/dns-query',
    params={'name': 'tmdb.org', 'type': 'A'},
    headers={'accept': 'application/dns-json'}
)
```

## 总结

**立即行动：**
```bash
# 运行这个就可以了
python3 check_tmdb_simple.py
```

这是目前最稳定、最不容易出问题的方案！
