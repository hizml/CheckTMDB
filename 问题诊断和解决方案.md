# CheckTMDB 报错诊断和解决方案

## 问题描述

运行 `check_tmdb_github_dnschecked.py` 时出现错误：
```
程序出错：未获取任何domain及对应IP，请检查接口~
```

## 问题原因分析

### 1. 根本原因
脚本在 285-287 行检查 `ipv4_results` 和 `ipv6_results` 是否为空。如果两者都为空，说明所有域名的 DNS 查询都失败了。

### 2. 可能的具体原因

#### 原因 A: dnschecked.com API 失效或变更 (最可能)
- API 端点: `https://api.dnschecked.com/query_dns`
- 可能该服务已经停止、更改接口格式、或增加了限流/验证
- 症状: 所有 POST 请求返回非 200 状态码，或响应格式不符合预期

#### 原因 B: DNS 服务器无响应
- 日本 DNS 服务器可能宕机或屏蔽了查询请求
  - `202.248.37.74`
  - `202.248.20.133`

#### 原因 C: 网络问题
- 本地网络限制
- 防火墙拦截
- SSL 证书问题

#### 原因 D: API 请求格式错误
- headers 或 params 格式不符合最新要求
- 缺少必要的认证信息

## 解决方案

### 方案 1: 使用修复版脚本 (推荐)

我已经创建了 `check_tmdb_fixed.py`，它实现了三种备用方案：

1. **方法1**: dnschecked.com API (原方法)
2. **方法2**: 系统 DNS 解析 (`socket.getaddrinfo`)
3. **方法3**: Cloudflare DNS-over-HTTPS

**使用方法:**
```bash
python check_tmdb_fixed.py
```

**优势:**
- 自动降级: 方法1失败会尝试方法2，方法2失败会尝试方法3
- 更详细的日志输出，方便诊断问题
- 不依赖单一 API 服务

### 方案 2: 测试诊断

先运行测试脚本确定问题根源：

```bash
python test_api.py
```

该脚本会：
- 测试 dnschecked.com API 是否可用
- 测试备用的系统 DNS 解析是否工作
- 输出详细的错误信息

### 方案 3: 修改原脚本使用其他 DNS 服务器

在 `check_tmdb_github_dnschecked.py` 中修改 DNS 服务器：

```python
# 原配置
dns_server = {
    "south-korea-dns": ["202.46.34.75", "168.126.63.1"],
    "japan-dns": ["202.248.37.74", "202.248.20.133"]
}

# 改为公共 DNS
dns_server = {
    "google-dns": ["8.8.8.8", "8.8.4.4"],
    "cloudflare-dns": ["1.1.1.1", "1.0.0.1"]
}

# 然后在 main() 函数中使用
ipv4_ips = get_domain_ips(domain, "A", dns_server["google-dns"])
```

### 方案 4: 切换回 dnschecker.org API

使用原来的 `check_tmdb_github.py` 脚本：

```bash
python check_tmdb_github.py
```

该脚本使用 dnschecker.org API 而非 dnschecked.com，可能更稳定。

### 方案 5: 使用 DNS 查询库

安装 `dnspython` 库：

```bash
pip install dnspython
```

然后修改代码使用真正的 DNS 查询而非 HTTP API：

```python
import dns.resolver

def get_domain_ips_via_dnspython(domain, record_type, dns_server):
    resolver = dns.resolver.Resolver()
    resolver.nameservers = [dns_server]
    
    try:
        answers = resolver.resolve(domain, record_type)
        return [str(rdata) for rdata in answers]
    except Exception as e:
        print(f"DNS查询失败: {e}")
        return []
```

## 临时解决方案

如果所有自动方法都失败，可以手动获取 IP：

1. 访问 https://dnschecker.org
2. 手动输入域名查询
3. 复制结果手动更新 `Tmdb_host_ipv4` 和 `Tmdb_host_ipv6`

## 调试建议

### 1. 检查网络连接
```bash
# 测试能否访问 API
curl -v https://api.dnschecked.com/query_dns

# 测试 DNS 服务器连通性
ping 202.248.37.74
```

### 2. 查看详细错误
修改 `check_tmdb_github_dnschecked.py` 的第 192 行，打印完整响应：

```python
print(f"完整响应: {response.text}")
print(f"响应头: {response.headers}")
```

### 3. 检查 API 变化
访问 https://dnschecked.com 查看页面是否有变化，用浏览器开发者工具查看实际的 API 请求格式。

### 4. 测试单个域名
临时修改 `DOMAINS` 列表只保留一个域名进行测试：

```python
DOMAINS = ['tmdb.org']  # 只测试一个
```

## GitHub Actions 修复

如果是在 GitHub Actions 中运行失败，修改 `.github/workflows/main.yml`:

```yaml
- name: Run Python script
  run: |
    # 先尝试修复版脚本
    sudo python check_tmdb_fixed.py || \
    # 失败则尝试原 dnschecker 方法
    sudo python check_tmdb_github.py || \
    # 都失败则报告但不中断
    echo "All methods failed, using cached data"
```

## 预防措施

1. **添加日志**: 详细记录每次 API 调用的结果
2. **添加缓存**: 保存上一次成功的结果作为备份
3. **多服务备份**: 同时使用多个 DNS 查询服务
4. **降级策略**: API 失败时自动切换到本地 DNS 解析

## 总结

**立即尝试的顺序:**
1. 运行 `python check_tmdb_fixed.py` (最快解决)
2. 运行 `python test_api.py` (诊断问题)
3. 如果网络正常,改用 `python check_tmdb_github.py`
4. 考虑更换 DNS 服务器为 Google DNS (8.8.8.8)
