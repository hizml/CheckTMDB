# CheckTMDB 使用指南

## 快速开始

### 方案一：check_tmdb_dns.py（推荐）⭐⭐⭐⭐⭐

**最稳定、最简单的方案**

```bash
# 直接运行，无需安装依赖
python3 check_tmdb_dns.py
```

**特点：**
- ✅ 只使用系统 DNS 解析
- ✅ 无需任何外部依赖
- ✅ 不会因第三方 API 失效而无法使用
- ✅ 适合 99% 的使用场景

**适用场景：**
- 本地网络正常
- 系统 DNS 可用
- 希望脚本简单稳定

---

### 方案二：check_tmdb_doh.py（备用）⭐⭐⭐⭐

**双重保障，成功率更高**

```bash
# 需要先安装依赖
pip install requests retry

# 运行脚本
python3 check_tmdb_doh.py
```

**特点：**
- ✅ 优先使用系统 DNS
- ✅ 失败时自动切换到 Cloudflare DoH
- ✅ 双重备用机制
- ✅ 会显示使用了哪个方法

**适用场景：**
- 系统 DNS 不稳定或被污染
- 需要更高的成功率
- 网络环境复杂

**输出示例：**
```
正在获取 tmdb.org 的 A 记录...
  [方法1] 使用系统 DNS 解析...
    ✓ 成功获取: ['13.225.158.58']
✓ 【方法1: 系统 DNS】成功获取到 1 个IP: ['13.225.158.58']
```

---

## 两个脚本的对比

| 特性 | check_tmdb_dns.py | check_tmdb_doh.py |
|------|------------------|-------------------|
| **依赖** | 无（仅标准库） | requests, retry |
| **方法数量** | 1 种 | 2 种（自动降级） |
| **稳定性** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| **成功率** | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| **速度** | 快 | 中等（有备用尝试） |
| **复杂度** | 简单 | 中等 |
| **推荐度** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |

## 工作原理

### check_tmdb_dns.py

```
开始
  ↓
遍历每个域名
  ↓
使用系统 DNS 查询 IPv4/IPv6
  ↓
测试延迟，选择最快的 IP
  ↓
保存到 hosts 文件
  ↓
结束
```

### check_tmdb_doh.py

```
开始
  ↓
遍历每个域名
  ↓
尝试方法1: 系统 DNS 查询
  ↓ (失败)
尝试方法2: Cloudflare DoH
  ↓
测试延迟，选择最快的 IP
  ↓
保存到 hosts 文件
  ↓
结束
```

## 输出文件

两个脚本都会生成/更新以下文件：

1. **Tmdb_host_ipv4** - IPv4 hosts 列表
2. **Tmdb_host_ipv6** - IPv6 hosts 列表  
3. **README.md** - 包含最新 hosts 内容的说明文档

## 使用场景推荐

### 个人电脑使用
```bash
# 推荐使用 DNS 版本
python3 check_tmdb_dns.py
```

### GitHub Actions / CI 环境
```bash
# 推荐使用 DoH 版本（更可靠）
python3 check_tmdb_doh.py
```

### NAS / 路由器使用
```bash
# 推荐使用 DNS 版本（依赖少）
python3 check_tmdb_dns.py
```

## GitHub Actions 配置建议

修改 `.github/workflows/main.yml`:

```yaml
- name: Run Python script
  run: |
    # 优先使用 DoH 版本（GitHub Actions 网络环境复杂）
    sudo python3 check_tmdb_doh.py || \
    # 备用 DNS 版本
    sudo python3 check_tmdb_dns.py || \
    echo "All methods failed"
```

## 常见问题

### Q1: 哪个脚本更快？
**A**: `check_tmdb_dns.py` 更快，因为只使用一种方法。

### Q2: 哪个脚本成功率更高？
**A**: `check_tmdb_doh.py` 成功率更高，有备用方案。

### Q3: 需要安装什么依赖？
**A**: 
- `check_tmdb_dns.py`: 无需安装，Python 3 自带
- `check_tmdb_doh.py`: 需要 `pip install requests retry`

### Q4: 如果两个都失败怎么办？
**A**: 
1. 检查网络连接
2. 尝试更换 DNS 服务器（系统设置）
3. 检查防火墙设置

### Q5: 可以同时运行两个脚本吗？
**A**: 可以，但没必要。推荐只运行一个。

### Q6: 原来的脚本去哪了？
**A**: 已移动到 `deprecated/` 文件夹，因为依赖的 API 已失效。

## 故障排查

### 问题：所有域名都查询失败

**check_tmdb_dns.py:**
```bash
# 检查系统 DNS
python3 -c "import socket; print(socket.getaddrinfo('tmdb.org', None))"

# 检查网络连接
ping tmdb.org
```

**check_tmdb_doh.py:**
```bash
# 测试 Cloudflare DoH
curl "https://cloudflare-dns.com/dns-query?name=tmdb.org&type=A" \
  -H "accept: application/dns-json"
```

### 问题：获取的 IP 延迟很高

这是正常的，脚本会自动选择延迟最低的 IP。如果所有 IP 延迟都高：
1. 可能是你的网络到 TMDB 的路由问题
2. 尝试使用 VPN 或代理
3. 等待一段时间后重新运行

## 升级建议

如果你之前使用的是：
- `check_tmdb_github.py` → 改用 `check_tmdb_dns.py`
- `check_tmdb_github_dnschecked.py` → 改用 `check_tmdb_doh.py`

原因：旧脚本依赖的第三方 API 已失效（403错误或无响应）。

---

**推荐操作：**
```bash
# 大多数情况直接用这个
python3 check_tmdb_dns.py
```

就这么简单！🎉
